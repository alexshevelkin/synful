Bootstrap: docker
From: ubuntu:18.04

%setup

    mkdir -p ${SINGULARITY_ROOTFS}/src/augment
    mkdir -p ${SINGULARITY_ROOTFS}/src/numcodecs
    mkdir -p ${SINGULARITY_ROOTFS}/src/zarr
    mkdir -p ${SINGULARITY_ROOTFS}/src/gunpowder
    mkdir -p ${SINGULARITY_ROOTFS}/src/daisy
    mkdir -p ${SINGULARITY_ROOTFS}/src/funlib
    mkdir -p ${SINGULARITY_ROOTFS}/src/synful

%files

    ../synful /src/synful/synful
    ../requirements.txt /src/synful/requirements.txt
    ../setup.py /src/synful/setup.py

%labels

    Version 0.1 # synful version: 90bb992b6e4c903295d1138c6a5b1853cd8fd27d

%post

    # basic ubuntu packages
    apt update
    apt install -y --no-install-recommends \
    build-essential \
    ca-certificates \
    cmake \
    git \
    libmlpack-dev \
    liblzma-dev \
    wget && \
    rm -rf /var/lib/apt/lists/*

    # install conda

    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /miniconda
    PATH="/miniconda/bin:$PATH"
    conda config --set always_yes yes --set changeps1 no
    conda update -q conda
    conda info -a
    conda install python=3.6

    # install tensorflow

    conda install tensorflow-gpu==1.3

    NUMCODECS_ROOT=/src/numcodecs
    NUMCODECS_REPOSITORY=https://github.com/funkey/numcodecs
    NUMCODECS_REVISION=f950047d7b666723f81006cbdfd82c0e6705c39c

    cd ${NUMCODECS_ROOT}
    git clone ${NUMCODECS_REPOSITORY} . && \
    git checkout ${NUMCODECS_REVISION} && \
    git submodule update --init --recursive
    pip install -r requirements.txt
    python setup.py install

    # Install ZARR
    ZARR_ROOT=/src/zarr
    ZARR_REPOSITORY=https://github.com/funkey/zarr
    ZARR_REVISION=9ddf849a6e3329f5ff361ebf6156712926e2fdfe

    cd ${ZARR_ROOT}
    git clone ${ZARR_REPOSITORY} . && \
    git checkout ${ZARR_REVISION}
    pip install -r requirements.txt
    python setup.py install

    conda install -c conda-forge z5py

    GUNPOWDER_ROOT=/src/gunpowder
    GUNPOWDER_REPOSITORY=https://github.com/funkey/gunpowder.git
    GUNPOWDER_REVISION=3054ebd8286e4c680bc7b73582d3207bdcd00922

    cd ${GUNPOWDER_ROOT}
    git clone ${GUNPOWDER_REPOSITORY} . && \
    git checkout ${GUNPOWDER_REVISION}
    pip install -r requirements.txt
    python setup.py build_ext --inplace
    PYTHONPATH=${GUNPOWDER_ROOT}:$PYTHONPATH

    DAISY_ROOT=/src/daisy
    DAISY_REPOSITORY=https://github.com/funkelab/daisy
    DAISY_REVISION=41130e58582ae05d01d26261786de0cbafaa6482

    cd ${DAISY_ROOT}
    git clone ${DAISY_REPOSITORY} . && \
    git checkout ${DAISY_REVISION}
    pip install -r requirements.txt
    python setup.py build_ext --inplace
    PYTHONPATH=${DAISY_ROOT}:$PYTHONPATH

    FUNLIB_ROOT=/src/funlib
    FUNLIB_REPOSITORY=https://github.com/funkelab/funlib.learn.tensorflow
    FUNLIB_REVISION=0712fee6b6c083c6bfc86e76f475b2e40b3c64f2

    cd ${FUNLIB_ROOT}
    git clone ${FUNLIB_REPOSITORY} . && \
    git checkout ${FUNLIB_REVISION}
    pip install -r requirements.txt
    python setup.py build_ext --inplace
    PYTHONPATH=${FUNLIB_ROOT}:$PYTHONPATH

    pip install mahotas
    pip install pymongo
    pip install neuroglancer



    # install synful
    cd /src/synful
    pip install -r requirements.txt
    python setup.py install

%environment

    export PYTHONPATH=/src/synful:$PYTHONPATH
    export AUGMENT_ROOT=/src/augment
    export PYTHONPATH=${AUGMENT_ROOT}:$PYTHONPATH
    export GUNPOWDER_ROOT=/src/gunpowder
    export PYTHONPATH=${GUNPOWDER_ROOT}:$PYTHONPATH
    export DAISY_ROOT=/src/daisy
    export PYTHONPATH=${DAISY_ROOT}:$PYTHONPATH
    export FUNLIB_ROOT=/src/funlib
    export PYTHONPATH=${FUNLIB_ROOT}:$PYTHONPATH
    export PATH=/miniconda/bin:${PATH}
    export OMP_NUM_THREADS=1 # prevent multithreading

%runscript

    exec /bin/bash "$@"
